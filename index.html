<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-firestore.js"></script>

        <script>
            const userMap = {
                "qwe23Sad": "d",
                "helloworld": "k",
            };

            var loginDiv;
            var pwdInput;
            var txtInput;
            var sendButton;
            var db;
            var who;
            var messagesQuery;

            function save(txt) {
                var now = new firebase.firestore.Timestamp.now();

                return db.collection("messages").add({
                    txt: txt,
                    who: who,
                    at: now
                })
            }

            function onLoginClick() {
                console.log(pwdInput, pwdInput.value);
                var user = userMap[pwdInput.value];
                if (user == null) {
                    console.log("unknown user");
                    return;
                }

                toggleUX();
                who = user;
                console.log("who", who);
            }

            function onSendClick() {
                console.log("sending");
                sendButton.disabled = true;
                let txt = txtInput.value.trim();

                save(txt)
                .then(() => {
                    console.log("Document successfully written!");
                    sendButton.disabled = false;
                })
                .catch((error) => {
                    console.error("Error writing document: ", error);
                    sendButton.disabled = false;
                });
            }

            function toggleUX() {
                loginDiv.hidden = true;
                contentDiv.hidden = false;
            }

            function createMessageContent(data) {
                let at = data.at.toDate();

                let msgDiv = document.createElement("div");

                let timeheader = document.createElement("small");
                timeheader.appendChild(document.createTextNode(at.toLocaleDateString() + " " + at.toLocaleTimeString()));

                msgDiv.appendChild(timeheader);
                
                let rows = data.txt.split("\n");
                for (let i in rows) {
                    msgDiv.appendChild(document.createElement("br"));
                    msgDiv.appendChild(document.createTextNode(rows[i]));
                }
                return msgDiv;
            }

            function addMessage(doc) {
                let content = createMessageContent(doc.data());
            }

            function onMessagesUpdate(snapshot) {
                console.log(snapshot);
                let content = [];

                snapshot.forEach((doc) => {
                    console.log(doc.data(), doc.id);
                    content.push(createMessageContent(doc.data()));
                });

                var prev = contentDiv.firstChild;
                for (let i in content) {
                    console.log(content[i]);
                    contentDiv.insertBefore(content[i], prev);
                }
            }

            function init() {
                console.log("init start");

                var firebaseConfig = {
                    apiKey: "AIzaSyBThzHgq5B34m00L4mZQ5eDLxXBmDlhqWQ",
                    authDomain: "dkhl2021.firebaseapp.com",
                    projectId: "dkhl2021",
                    storageBucket: "dkhl2021.appspot.com",
                    messagingSenderId: "900227237897",
                    appId: "1:900227237897:web:e507d80fc08bd493ae90d8",
                    measurementId: "G-5NTHRBEGG9"
                };

                firebase.initializeApp(firebaseConfig);
                console.log("init done");

                loginDiv = document.getElementById("login");
                contentDiv = document.getElementById("content");
                pwdInput = document.getElementById("pwd");
                txtInput = document.getElementById("txt");
                sendButton = document.getElementById("send");
                db = firebase.firestore();

                messagesQuery = db.collection("messages")
                    .orderBy("at", "desc")
                    .limit(100);

                messagesQuery.onSnapshot(onMessagesUpdate);
            }
        </script>

    </head>
    <body onload="onBodyLoad()">
        <div style="max-width: 1000px; margin: auto;">
            <div style="max-width: 250; margin: auto;">
                <img src="GitHub_Logo.png" width="250"/>
            </div>

            <div id="login" style="max-width: 500; margin: auto;">
                <input type="password" autocomplete="off" id="pwd" />
                <button type="button" onclick="onLoginClick()">Login</button>
            </div>
            
            <div id="content" hidden>
                <textarea autocomplete="off" id="txt" style="width: 1000px;" rows="10"></textarea>
                <br/>
                <br/>
                <button id="send" type="button" onclick="onSendClick()">Send</button>
            </div>
        </div>

        <script>
            function onBodyLoad() {
                init();
            }
        </script>

        <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-firestore.js"></script>
    </body>
</html>