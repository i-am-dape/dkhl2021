<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-firestore.js"></script>

    <script>
        class DivCtrl {
            constructor(div) {
                this.inner_ = div;
                this.hidden_ = (div.style.display == "none");
                if (this.hidden_) {
                    this.display_ = null;
                } else {
                    this.display_ = "none";
                }
            }

            show() {
                if (!this.hidden_) {
                    return;
                }

                this.inner_.style.display = this.display_;
                this.hidden_ = false;
            }

            hide() {
                if (this.hidden_) {
                    return;
                }

                this.display_ = this.inner_.style.display;
                this.inner_.style.display = "none";
                this.hidden_ = true;
            }

            hidden() {
                return this.hidden_;
            }
        }

        class AutohidingDivCtrl {
            constructor(div) {
                this.inner_ = new DivCtrl(div);
                this.cnt_ = 0;
            }

            show(hideAfterMs) {
                this.inner_.show();
                this.cnt_++;

                window.setTimeout((cnt) => {
                    if (this.cnt_ != cnt) {
                        console.log(`ignoring timer; ${this.cnt_} ${cnt}`);
                        return;
                    }

                    this.inner_.hide();
                }, 5000, this.cnt_);
            }

            hide() {
                this.inner_.hide();
            }
        }

        // userMap maps the passwords to users
        const userMap = {
            "qwe23Sad": "d",
            "helloworld": "k",
            "ofritt": "o",
        };

        var contentVisible;
        var loginDiv;
        var contentDiv;
        var txtCtrls = {};
        var postsDiv;
        var pwdInput;
        var txtInput;
        var sendButton;
        var db;

        // messagesSource is the firestore collection where the messages are
        // stored. This is normally 'messages' but we add suffixes '_dev' suffix
        // to it to avoid destroying real data during development. And we add
        // '_ofritt' to it if the 'ofritt' is used to hide content.
        var messagesSource;

        // initial of the logged in user, set from password input.
        var who;

        // firestore query that listens to changes on the messages collection.
        var messagesQuery;
        // function that detaches the listener.
        var messagesQueryCancel;

        // messages holds ID -> div mapping for all already shown messages.
        // This is used to dedupe new messages as messagesQuery is updated
        // on every change to the collection.
        var messages = {};

        // lastActiveAt is the timestamp (date object) from the users
        // last activity; an activity is one of:
        // - showing a text section
        // - typing in the text area
        // - pressing send
        var lastActiveAt;

        function save(txt) {
            var now = new firebase.firestore.Timestamp.now();

            return db.collection(messagesSource).add({
                txt: txt,
                who: who,
                at: now
            })
        }

        function onLoginClick() {
            console.log(pwdInput, pwdInput.value);
            var user = userMap[pwdInput.value];
            if (user == null) {
                console.log("unknown user");
                return;
            }

            if (messagesQueryCancel != null) {
                console.debug("detaching messages listener");
                messagesQueryCancel();
                messagesQueryCancel = null;

                for (let id in messages) {
                    messages[id].div.remove();
                }

                messages = {};
            }

            messagesQuery = db.collection(messagesSource)
                .orderBy("at", "desc")
                .limit(100);

            messagesQueryCancel = messagesQuery.onSnapshot(onMessagesUpdate);

            updateLastActiveAt();
            pwdInput.value = "";
            toggleUX();
            who = user;
            console.log("who", who);
        }

        function onSendClick() {
            console.log("sending");
            sendButton.disabled = true;
            let txt = txtInput.value.trim();
            updateLastActiveAt();

            save(txt)
            .then(() => {
                console.log("Document successfully written!");
                sendButton.disabled = false;
                txtInput.value = "";
            })
            .catch((error) => {
                console.error("Error writing document: ", error);
                sendButton.disabled = false;
            });
        }

        function toggleUX() {
            console.log(`swithing UX state: ${contentVisible}`);
            if (contentVisible) {
                loginDiv.show();
                contentDiv.hide();
                contentVisible = false;
            } else {
                loginDiv.hide();
                contentDiv.show();
                contentVisible = true;
            }
        }

        function onTimeHeaderClick(event) {
            updateLastActiveAt();
            let id = event.srcElement.nextSibling.dataset.ctrl;
            let ctrl = txtCtrls[id];
            ctrl.show(15000);
        }

        function createMessageContent(id, data) {
            let at = data.at.toDate();

            let msgDiv = document.createElement("div");
            msgDiv.appendChild(document.createElement("hr"));

            let timeheader = document.createElement("small");
            timeheader.appendChild(
                document.createTextNode(
                    "[" + data.who + "]:" + at.toLocaleDateString() + " " + at.toLocaleTimeString()));

            timeheader.addEventListener("click", onTimeHeaderClick, false);
            msgDiv.appendChild(timeheader);
            
            let txtDiv = document.createElement("div");
            txtDiv.dataset.foo = "1";
            msgDiv.appendChild(txtDiv);
            txtDiv.style.margin = "10px";
            txtDiv.style.color = "lightgrey";
            let rows = data.txt.split("\n");
            for (let i in rows) {
                txtDiv.appendChild(document.createElement("br"));
                txtDiv.appendChild(document.createTextNode(rows[i]));
            }
            let txtCtrl = new AutohidingDivCtrl(txtDiv);
            txtCtrls[id] = txtCtrl;
            txtDiv.dataset.ctrl = id;
            txtCtrl.hide();

            return msgDiv;
        }

        function onMessagesUpdate(snapshot) {
            console.log(snapshot);
            let content = [];

            snapshot.forEach((doc) => {
                if (doc.id in messages) {
                    console.info('skipping id:', doc.id);
                    return;
                }
                console.log(doc.data(), doc.id);
                content.push({div:createMessageContent(doc.id, doc.data()), id:doc.id})
            });

            var prev = postsDiv.firstChild;
            for (let i in content) {
                postsDiv.insertBefore(content[i].div, prev);
                messages[content[i].id] = content[i];
            }
        }

        function handleTabHidden() {
        }

        function handleTabShown() {
        }

        function onPageHide() {
            console.log("pagehide change", document["webkitHidden"]);
            if (document.hidden) {
                handleTabHidden();
            } else {
                handleTabShown();
            }
        }

        function onVisibilityChange() {
            console.log("viz change", document["webkitHidden"]);
            if (document.hidden) {
                handleTabHidden();
            } else {
                handleTabShown();
            }
        }

        function onTyping() {
            updateLastActiveAt();
        }

        function onGlobalTimerTick() {
            if (!contentVisible) {
                return;
            }

            let dT = (new Date()) - lastActiveAt;
            console.debug("last active " + dT + "mS ago");
            if (dT > 2 * 60 * 1000) {
                toggleUX();
            }
        }

        function updateLastActiveAt() {
            lastActiveAt = new Date();
            console.debug("last active at updated");
        }

        function init() {
            console.log("init start");
            contentVisible = false;
            messagesSource = "messages";
            console.debug(`url: ${document.URL}`);
            if (document.URL != "https://i-am-dape.github.io/dkhl2021/") {
                messagesSource += "_dev";
            }

            console.debug(`firestore collection: ${messagesSource}`);

            var firebaseConfig = {
                apiKey: "AIzaSyBThzHgq5B34m00L4mZQ5eDLxXBmDlhqWQ",
                authDomain: "dkhl2021.firebaseapp.com",
                projectId: "dkhl2021",
                storageBucket: "dkhl2021.appspot.com",
                messagingSenderId: "900227237897",
                appId: "1:900227237897:web:e507d80fc08bd493ae90d8",
                measurementId: "G-5NTHRBEGG9"
            };

            firebase.initializeApp(firebaseConfig);
            console.log("init done");

            updateLastActiveAt();

            loginDiv = new DivCtrl(document.getElementById("login"));
            contentDiv = new DivCtrl(document.getElementById("content"));
            postsDiv = document.getElementById("posts");
            pwdInput = document.getElementById("pwd");
            txtInput = document.getElementById("txt");
            sendButton = document.getElementById("send");
            db = firebase.firestore();

            document.addEventListener("webkitvisibilitychange", onVisibilityChange, false);
            window.addEventListener("pagehide", onPageHide, false);

            window.setInterval(onGlobalTimerTick, 10 * 1000);
        }
    </script>
  </head>
  <body onload="onBodyLoad()">
    <div style="max-width: 1000px; margin: auto;">
      <div style="max-width: 250; margin: auto;">
        <img src="GitHub_Logo.png" width="250" />
      </div>

      <div id="login" style="max-width: 500; margin: auto; justify-content: center; display: flex;">
        <input type="password" autocomplete="off" id="pwd" />
        <button type="button" onclick="onLoginClick()">Login</button>
      </div>
        
      <div id="content" style="display: none;">
        <textarea autocomplete="off" id="txt" style="width: 1000px; color: lightgray;" rows="10" onkeypress="onTyping()"></textarea>
        <br/>
        <br/>
        <button id="send" type="button" onclick="onSendClick()">Send</button>
        <div id="posts">
            <!-- nodes are added here dynamically through javascript as messages arrive -->
        </div>
      </div>
    </div>

    <script>
      function onBodyLoad() {
        init();
      }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-firestore.js"></script>
  </body>
</html>
